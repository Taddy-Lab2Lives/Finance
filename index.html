<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BenKon NPV Analysis - So s√°nh chi ph√≠ v√≤ng ƒë·ªùi</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <script>
        // Simple Chart.js loading check
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking Chart.js...');
            setTimeout(() => {
                if (typeof Chart !== 'undefined') {
                    console.log('‚úÖ Chart.js loaded successfully, version:', Chart.version || 'unknown');
                } else {
                    console.error('‚ùå Chart.js failed to load');
                    alert('Chart.js failed to load. Please check your internet connection and refresh the page.');
                }
            }, 1000);
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        /* Input Section */
        .input-section {
            margin-bottom: 30px;
        }

        .basic-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #495057;
            font-size: 0.85rem;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-group input {
            width: 100%;
            padding: 8px 40px 8px 12px;
            border: 2px solid #e1e4e8;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-unit {
            position: absolute;
            right: 12px;
            color: #6c757d;
            font-size: 0.85rem;
            pointer-events: none;
        }

        /* Comparison Table */
        .comparison-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 30px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .comparison-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .comparison-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 1rem;
        }

        .comparison-table th:first-child {
            width: 25%;
        }

        .comparison-table tbody tr {
            border-bottom: 1px solid #e9ecef;
        }

        .comparison-table tbody tr:hover {
            background: #f8f9fa;
        }

        .comparison-table td {
            padding: 12px 15px;
            font-size: 0.95rem;
        }

        .comparison-table td:first-child {
            font-weight: 500;
            color: #6c757d;
        }

        .section-header {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .section-header td {
            padding: 10px 15px !important;
        }

        .input-cell input {
            width: 100%;
            padding: 6px 35px 6px 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .input-cell input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .input-cell {
            position: relative;
        }

        .input-cell .unit {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 0.85rem;
            pointer-events: none;
        }

        .result-row {
            background: #f8f9fa;
        }

        .result-row td {
            font-weight: 600;
        }

        .npv-row {
            background: linear-gradient(135deg, #f6ffed 0%, #e6f7ff 100%);
        }

        .npv-row td {
            font-size: 1.1rem;
            font-weight: 700;
            padding: 15px;
        }

        .winner-cell {
            color: #28a745;
            position: relative;
        }

        .winner-cell::after {
            content: '‚úì T·ªëi ∆∞u';
            position: absolute;
            top: -8px;
            right: 15px;
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Chart Section */
        .chart-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #e9ecef;
            margin-bottom: 30px;
        }

        .chart-title {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        /* Conclusion */
        .conclusion {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #dee2e6;
        }

        .conclusion h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .conclusion p {
            font-size: 1rem;
            color: #495057;
        }
        
        .evaluation-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .evaluation-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .evaluation-table th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .evaluation-table tbody tr {
            border-bottom: 1px solid #f1f3f5;
        }
        
        .evaluation-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .evaluation-table td {
            padding: 12px 15px;
            font-size: 0.88rem;
            vertical-align: top;
        }
        
        .evaluation-table .criteria-number {
            font-weight: 700;
            color: #667eea;
            font-size: 1rem;
        }
        
        .evaluation-table .weight {
            font-weight: 700;
            color: #667eea;
        }
        
        .evaluation-table .perspective {
            background: #e6f7ff;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            color: #1890ff;
            font-size: 0.82rem;
            display: inline-block;
        }
        
        .evaluation-summary {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .recommendation-score {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .score-item {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .score-item strong {
            display: block;
            font-size: 1.3rem;
            color: #667eea;
            margin-bottom: 4px;
        }
        
        .score-item span {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .calculate-btn {
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }

        .calculate-btn:active {
            transform: translateY(-1px);
        }

        .footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            color: #6c757d;
            font-size: 0.95rem;
            border-top: 1px solid #e9ecef;
        }

        .footer strong {
            color: #667eea;
            font-weight: 600;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 5px;
            color: #6c757d;
            font-size: 0.8rem;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-container {
            text-align: center;
            margin: 20px 0;
        }

        /* Formula Notes */
        .formula-notes {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            border: 1px solid #e9ecef;
        }

        .formula-notes h3 {
            color: #2c3e50;
            font-size: 1.3rem;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .formula-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .formula-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .formula-item h4 {
            color: #667eea;
            font-size: 1.1rem;
            margin-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 5px;
        }

        .formula-item p {
            font-size: 0.95rem;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .formula-item ul {
            margin: 0;
            padding-left: 20px;
        }

        .formula-item li {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .pv-formula {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .pv-formula h4 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: white;
        }

        .pv-formula p {
            font-size: 1.1rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .pv-formula ul {
            text-align: left;
            display: inline-block;
            margin: 0;
            padding-left: 20px;
        }

        .pv-formula li {
            font-size: 0.95rem;
            margin-bottom: 5px;
            opacity: 0.95;
        }

        /* Cash Flow Table */
        .cash-flow-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .cash-flow-title {
            font-weight: 700;
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .cash-flow-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            font-size: 0.9rem;
        }

        .cash-flow-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .cash-flow-table th {
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .cash-flow-table th:first-child {
            text-align: left;
            padding-left: 15px;
        }

        .cash-flow-table tbody tr {
            border-bottom: 1px solid #e9ecef;
        }

        .cash-flow-table tbody tr:hover {
            background: #f8f9fa;
        }

        .cash-flow-table tbody tr:last-child {
            border-bottom: none;
        }

        .cash-flow-table td {
            padding: 10px 8px;
            text-align: center;
        }

        .cash-flow-table td:first-child {
            text-align: left;
            font-weight: 500;
            color: #495057;
            padding-left: 15px;
        }

        .cash-flow-table .year-header {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .cash-flow-table .total-row {
            background: linear-gradient(135deg, #f6ffed 0%, #e6f7ff 100%);
            font-weight: 700;
            color: #2c3e50;
        }

        .cash-flow-table .negative {
            color: #dc3545;
        }

        .cash-flow-table .positive {
            color: #28a745;
        }

        @media (max-width: 1200px) {
            .basic-inputs {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .basic-inputs {
                grid-template-columns: 1fr;
            }
            
            .comparison-table {
                font-size: 0.85rem;
            }
            
            .comparison-table th,
            .comparison-table td {
                padding: 8px;
            }

            .cash-flow-table {
                font-size: 0.8rem;
            }
            
            .cash-flow-table th,
            .cash-flow-table td {
                padding: 8px 4px;
            }
            
            .cash-flow-table th:first-child,
            .cash-flow-table td:first-child {
                padding-left: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>BenKon NPV Analysis Tool</h1>
            <p>So s√°nh chi ph√≠ t·ªïng v√≤ng ƒë·ªùi gi·ªØa c√°c m√¥ h√¨nh ƒë·∫ßu t∆∞</p>
        </div>
        
        <div class="content">
            <!-- Basic Inputs -->
            <div class="input-section">
                <div class="basic-inputs">
                    <div class="input-group">
                        <label>CapEx - Su·∫•t ƒë·∫ßu t∆∞
                            <span class="tooltip" data-tooltip="Chi ph√≠ mua thi·∫øt b·ªã m·ªõi">‚ìò</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="capex" value="1100" step="10">
                            <span class="input-unit">tri·ªáu</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Ti·ªÅn ƒëi·ªán hi·ªán t·∫°i
                            <span class="tooltip" data-tooltip="Chi ph√≠ ƒëi·ªán nƒÉng h√†ng th√°ng">‚ìò</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="electric" value="76" step="1">
                            <span class="input-unit">tri·ªáu</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Cam k·∫øt ti·∫øt ki·ªám BenKon
                            <span class="tooltip" data-tooltip="% cam k·∫øt ti·∫øt ki·ªám nƒÉng l∆∞·ª£ng t·ª´ BenKon">‚ìò</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="saving" value="20" step="1" min="0" max="50">
                            <span class="input-unit">%</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>L√£i su·∫•t chi·∫øt kh·∫•u
                            <span class="tooltip" data-tooltip="Discount rate cho DCF">‚ìò</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="discount" value="1" step="0.5">
                            <span class="input-unit">%/nƒÉm</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Th·ªùi h·∫°n thu√™ (BenKon)</label>
                        <div class="input-wrapper">
                            <input type="number" id="years" value="7" step="1" min="1" max="20">
                            <span class="input-unit">nƒÉm</span>
                        </div>
                    </div>


                    <div class="input-group">
                        <label>Th·ªùi h·∫°n (Thu√™ TC)</label>
                        <div class="input-wrapper">
                            <input type="number" id="years-fin" value="4" step="1" min="1" max="20">
                            <span class="input-unit">nƒÉm</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>L√£i su·∫•t thu√™ TC
                            <span class="tooltip" data-tooltip="L√£i su·∫•t vay cho thu√™ t√†i ch√≠nh">‚ìò</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="fin-interest" value="12" step="0.5" min="0" max="30">
                            <span class="input-unit">%/nƒÉm</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>S·ªë m√°y l·∫°nh</label>
                        <div class="input-wrapper">
                            <input type="number" id="aircon-units" value="20" step="1" min="1">
                            <span class="input-unit">m√°y</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>D·ªãch v·ª• b·∫£o tr√¨ Premium (% CapEx)
                            <span class="tooltip" data-tooltip="D·ªãch v·ª• b·∫£o tr√¨ ch√≠nh h√£ng Premium theo % v·ªën ƒë·∫ßu t∆∞">‚ìò</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="premium-maint-pct" value="8" step="0.1" min="0" max="20">
                            <span class="input-unit">% nƒÉm</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Ph√≠ b·∫£o tr√¨ hi·ªán t·∫°i (Kh√°ch h√†ng)
                            <span class="tooltip" data-tooltip="Chi ph√≠ b·∫£o tr√¨ h√†ng th√°ng kh√°ch h√†ng ƒëang s·ª≠ d·ª•ng">‚ìò</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="current-maint" value="4" step="0.1" min="0">
                            <span class="input-unit">tri·ªáu/th√°ng</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Ph√≠ qu·∫£n l√Ω chung
                            <span class="tooltip" data-tooltip="Chi ph√≠ qu·∫£n l√Ω h√†ng th√°ng (√°p d·ª•ng cho T·ª± ƒë·∫ßu t∆∞ v√† Thu√™ t√†i ch√≠nh)">‚ìò</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="management-fee" value="2" step="0.1" min="0">
                            <span class="input-unit">tri·ªáu/th√°ng</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Ph√≠ t·ªëi ∆∞u nƒÉng l∆∞·ª£ng/AC
                            <span class="tooltip" data-tooltip="Chi ph√≠ t·ªëi ∆∞u nƒÉng l∆∞·ª£ng cho m·ªói m√°y l·∫°nh/th√°ng">‚ìò</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="optimize-fee-per-ac" value="199" step="10" min="0">
                            <span class="input-unit">ngh√¨n</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Deposit (Thu√™ TC)
                            <span class="tooltip" data-tooltip="% CapEx c·∫ßn ƒë·∫∑t c·ªçc ban ƒë·∫ßu">‚ìò</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="deposit" value="30" step="5" min="0" max="100">
                            <span class="input-unit">%</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Deposit (BenKon)
                            <span class="tooltip" data-tooltip="% CapEx c·∫ßn ƒë·∫∑t c·ªçc cho thu√™ v·∫≠n h√†nh">‚ìò</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="deposit-oper" value="10" step="5" min="0" max="100">
                            <span class="input-unit">%</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Gi√° mua l·∫°i (Thu√™ TC)
                            <span class="tooltip" data-tooltip="% CapEx ƒë·ªÉ mua l·∫°i sau khi h·∫øt h·∫°n thu√™ t√†i ch√≠nh">‚ìò</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="number" id="residual-value" value="10" step="5" min="0" max="50">
                            <span class="input-unit">%</span>
                        </div>
                    </div>
                </div>

                <div class="btn-container">
                    <button class="calculate-btn" onclick="calculate()">T√çNH TO√ÅN & SO S√ÅNH</button>
                </div>
            </div>

            <!-- Comparison Table Placeholder -->
            <div id="comparisonTablePlaceholder" style="display:block;">
                <div style="text-align: center; padding: 40px; color: #667eea; font-size: 1rem; background: rgba(248, 249, 250, 0.8); border-radius: 12px; border: 2px dashed #dee2e6; margin: 20px 0;">
                    <div style="margin-bottom: 10px; font-size: 1.8rem;">üìà</div>
                    <div style="font-weight: 600;">Nh·∫•n n√∫t "T√çNH TO√ÅN & SO S√ÅNH" ƒë·ªÉ xem b·∫£ng so s√°nh chi ti·∫øt</div>
                </div>
            </div>
            
            <!-- Comparison Table -->
            <div id="comparisonTableContainer" style="display:none;">
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Th√¥ng s·ªë</th>
                        <th>Mua thi·∫øt b·ªã (Buy)</th>
                        <th>Thu√™ t√†i ch√≠nh</th>
                        <th>Thu√™ v·∫≠n h√†nh (BenKon)</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Chi ph√≠ ban ƒë·∫ßu -->
                    <tr class="section-header">
                        <td colspan="4">CHI PH√ç BAN ƒê·∫¶U</td>
                    </tr>
                    <tr>
                        <td>CapEx ƒë·∫ßu t∆∞</td>
                        <td id="buy-capex">1,100.0 tri·ªáu</td>
                        <td id="fin-capex">330.0 tri·ªáu</td>
                        <td id="oper-capex">110.0 tri·ªáu</td>
                    </tr>

                    <!-- Chi ph√≠ h√†ng th√°ng -->
                    <tr class="section-header">
                        <td colspan="4">CHI PH√ç H√ÄNG TH√ÅNG (tri·ªáu VNƒê/th√°ng)</td>
                    </tr>
                    <tr>
                        <td>Ti·ªÅn ƒëi·ªán</td>
                        <td id="buy-electric">76.0 tri·ªáu</td>
                        <td id="fin-electric">76.0 tri·ªáu</td>
                        <td id="oper-electric">61.0 tri·ªáu</td>
                    </tr>
                    <tr>
                        <td>Ph√≠ thu√™ (%CapEx/th√°ng)</td>
                        <td class="input-cell">
                            <input type="number" id="buy-rent-pct" value="0" disabled>
                            <span class="unit">%</span>
                        </td>
                        <td class="input-cell">
                            <input type="number" id="fin-rent-pct" value="0" disabled>
                            <span class="unit">auto</span>
                        </td>
                        <td class="input-cell">
                            <input type="number" id="oper-rent-pct" value="2.5" step="0.1">
                            <span class="unit">%</span>
                        </td>
                    </tr>
                    <tr>
                        <td>Ph√≠ thu√™ (tri·ªáu/th√°ng)</td>
                        <td id="buy-rent">0.0 tri·ªáu</td>
                        <td id="fin-rent">22.0 tri·ªáu</td>
                        <td id="oper-rent">27.5 tri·ªáu</td>
                    </tr>
                    <tr>
                        <td>Ph√≠ b·∫£o tr√¨</td>
                        <td id="buy-maint-display">55.0 tri·ªáu (hi·ªán t·∫°i)</td>
                        <td id="fin-maint-display">4.0 tri·ªáu</td>
                        <td id="oper-maint-display">73.3 tri·ªáu (Premium)</td>
                    </tr>
                    <tr>
                        <td>Ph√≠ t·ªëi ∆∞u ƒëi·ªán nƒÉng</td>
                        <td class="input-cell">
                            <input type="number" id="buy-optimize" value="0" disabled>
                            <span class="unit">tri·ªáu</span>
                        </td>
                        <td class="input-cell">
                            <input type="number" id="fin-optimize" value="0" disabled>
                            <span class="unit">tri·ªáu</span>
                        </td>
                        <td class="input-cell">
                            <input type="number" id="oper-optimize" value="3.6" step="0.1">
                            <span class="unit">tri·ªáu</span>
                        </td>
                    </tr>
                    <tr>
                        <td>Ph√≠ qu·∫£n l√Ω b·∫£o tr√¨</td>
                        <td class="input-cell">
                            <input type="number" id="buy-mgmt" value="2" step="0.5" disabled>
                            <span class="unit">auto</span>
                        </td>
                        <td class="input-cell">
                            <input type="number" id="fin-mgmt" value="2" step="0.5" disabled>
                            <span class="unit">auto</span>
                        </td>
                        <td class="input-cell">
                            <input type="number" id="oper-mgmt" value="0" disabled>
                            <span class="unit">tri·ªáu</span>
                        </td>
                    </tr>
                    
                    <!-- T·ªïng k·∫øt -->
                    <tr class="result-row">
                        <td>T·ªïng chi ph√≠/th√°ng</td>
                        <td id="buy-monthly">133.0 tri·ªáu</td>
                        <td id="fin-monthly">155.0 tri·ªáu</td>
                        <td id="oper-monthly">99.6 tri·ªáu</td>
                    </tr>
                    
                    <tr class="npv-row">
                        <td>NPV (T·ªïng v√≤ng ƒë·ªùi)</td>
                        <td id="buy-npv" class="npv-value">12,190.0 tri·ªáu</td>
                        <td id="fin-npv" class="npv-value">11,080.0 tri·ªáu</td>
                        <td id="oper-npv" class="npv-value">8,388.0 tri·ªáu</td>
                    </tr>
                </tbody>
            </table>
            </div>

            <!-- Sensitivity Chart -->
            <div class="chart-section">
                <h3 class="chart-title">·∫¢nh h∆∞·ªüng c·ªßa ti·∫øt ki·ªám nƒÉng l∆∞·ª£ng (ŒîNPV so v·ªõi t·ª± ƒë·∫ßu t∆∞)</h3>
                <div style="position: relative; height: 400px;">
                    <canvas id="sensitivityChart"></canvas>
                    <div id="chartPlaceholder" style="display: flex; align-items: center; justify-content: center; height: 100%; position: absolute; top: 0; left: 0; right: 0; background: rgba(248, 249, 250, 0.9); border-radius: 8px;">
                        <div style="text-align: center; color: #667eea; font-size: 1.1rem;">
                            üìà Nh·∫•n n√∫t "T√çNH TO√ÅN & SO S√ÅNH" ƒë·ªÉ xem ·∫£nh h∆∞·ªüng ti·∫øt ki·ªám nƒÉng l∆∞·ª£ng
                        </div>
                    </div>
                </div>
            </div>

            <!-- CapEx Chart Section -->
            <div class="chart-section">
                <h3 class="chart-title">So s√°nh v·ªën ƒë·∫ßu t∆∞ ban ƒë·∫ßu (CapEx) - tri·ªáu VND</h3>
                <div style="position: relative; height: 400px;">
                    <canvas id="capexChart"></canvas>
                    <div id="capexChartPlaceholder" style="display: flex; align-items: center; justify-content: center; height: 100%; position: absolute; top: 0; left: 0; right: 0; background: rgba(248, 249, 250, 0.9); border-radius: 8px;">
                        <div style="text-align: center; color: #667eea; font-size: 1.1rem;">
                            üí∞ Nh·∫•n n√∫t "T√çNH TO√ÅN & SO S√ÅNH" ƒë·ªÉ xem so s√°nh v·ªën ƒë·∫ßu t∆∞
                        </div>
                    </div>
                </div>
            </div>

            <!-- OpEx Chart Section -->
            <div class="chart-section">
                <h3 class="chart-title">Chi ph√≠ v·∫≠n h√†nh OpEx qua c√°c th√°ng (tri·ªáu VND)</h3>
                <div style="position: relative; height: 400px;">
                    <canvas id="monthlyCashFlowChart"></canvas>
                    <div id="monthlyCashFlowChartPlaceholder" style="display: flex; align-items: center; justify-content: center; height: 100%; position: absolute; top: 0; left: 0; right: 0; background: rgba(248, 249, 250, 0.9); border-radius: 8px;">
                        <div style="text-align: center; color: #667eea; font-size: 1.1rem;">
                            üìä Nh·∫•n n√∫t "T√çNH TO√ÅN & SO S√ÅNH" ƒë·ªÉ xem bi·ªÉu ƒë·ªì chi ph√≠ v·∫≠n h√†nh
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conclusion -->
            <div class="conclusion" id="conclusion" style="display:none;">
                <!-- Conclusion will be inserted here -->
            </div>

            <!-- Cash Flow Table -->
            <div class="cash-flow-section">
                <h3 class="cash-flow-title">B·∫£ng d√≤ng ti·ªÅn theo nƒÉm (tri·ªáu VNƒê)</h3>
                <div style="overflow-x: auto;">
                    <table class="cash-flow-table" id="cashFlowTable">
                        <!-- Cash flow table will be populated by JavaScript -->
                        <thead>
                            <tr>
                                <th>NƒÉm</th>
                                <th>T·ª± ƒë·∫ßu t∆∞<br><small>(tri·ªáu VNƒê/nƒÉm)</small></th>
                                <th>Thu√™ t√†i ch√≠nh<br><small>(tri·ªáu VNƒê/nƒÉm)</small></th>
                                <th>Thu√™ v·∫≠n h√†nh (BenKon)<br><small>(tri·ªáu VNƒê/nƒÉm)</small></th>
                            </tr>
                        </thead>
                        <tbody id="cashFlowBody">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 20px; color: #667eea; font-size: 1rem;">
                                    üìä Nh·∫•n n√∫t "T√çNH TO√ÅN & SO S√ÅNH" ƒë·ªÉ xem b·∫£ng d√≤ng ti·ªÅn chi ti·∫øt
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Formula Notes Placeholder -->
            <div class="formula-notes" id="formulaPlaceholder" style="display:block;">
                <div style="text-align: center; padding: 60px; color: #667eea; font-size: 1.1rem; background: rgba(248, 249, 250, 0.8); border-radius: 12px; border: 2px dashed #dee2e6; margin: 20px 0;">
                    <div style="margin-bottom: 15px; font-size: 2.5rem;">üìä</div>
                    <div style="font-weight: 700; font-size: 1.2rem;">Nh·∫•n n√∫t "T√çNH TO√ÅN & SO S√ÅNH"</div>
                    <div style="font-size: 0.95rem; color: #6c757d; margin-top: 10px;">ƒë·ªÉ xem chi ti·∫øt c√¥ng th·ª©c t√≠nh NPV v·ªõi d·ªØ li·ªáu th·ª±c t·∫ø</div>
                </div>
            </div>

            <!-- NPV Formula Notes -->
            <div class="formula-notes" id="formulaNotes" style="display:none !important;">
                <h3>C√¥ng th·ª©c t√≠nh NPV (Net Present Value)</h3>
                <div class="formula-grid">
                    <div class="formula-item">
                        <h4>1. T·ª± ƒë·∫ßu t∆∞</h4>
                        <p><strong>NPV = CapEx + PV(Chi ph√≠ h√†ng th√°ng)</strong></p>
                        <ul>
                            <li>CapEx ban ƒë·∫ßu: <span id="formula-capex">1,100.0</span> tri·ªáu VNƒê</li>
                            <li>Ti·ªÅn ƒëi·ªán: <span id="formula-electric-buy">76.0</span> tri·ªáu/th√°ng</li>
                            <li>Ph√≠ b·∫£o tr√¨ hi·ªán t·∫°i: <span id="formula-maint-buy">55.0</span> tri·ªáu/th√°ng</li>
                            <li>Ph√≠ qu·∫£n l√Ω: <span id="formula-mgmt-buy">2.0</span> tri·ªáu/th√°ng</li>
                            <li><strong>T·ªïng chi ph√≠/th√°ng: <span id="formula-monthly-buy">133.0</span> tri·ªáu</strong></li>
                            <li>Kh√¥ng c√≥ cam k·∫øt ti·∫øt ki·ªám nƒÉng l∆∞·ª£ng</li>
                            <li>Th·ªùi gian so s√°nh: <span id="formula-comparison-period">10</span> nƒÉm</li>
                        </ul>
                    </div>
                    
                    <div class="formula-item">
                        <h4>2. Thu√™ t√†i ch√≠nh</h4>
                        <p><strong>NPV = Deposit + PV(Thu√™) + PV(Mua l·∫°i) + PV(V·∫≠n h√†nh sau thu√™)</strong></p>
                        <ul>
                            <li>Deposit ban ƒë·∫ßu: <span id="formula-deposit">30</span>% √ó <span id="formula-capex-2">1,100.0</span> = <span id="formula-deposit-amount">330.0</span> tri·ªáu</li>
                            <li>V·ªën vay: (100% - <span id="formula-deposit-2">30</span>%) √ó CapEx = <span id="formula-principal">770.0</span> tri·ªáu</li>
                            <li>L√£i su·∫•t vay: <span id="formula-fin-interest">12</span>%/nƒÉm ‚Üí PMT = <span id="formula-fin-rent">22.0</span> tri·ªáu/th√°ng</li>
                            <li>Chi ph√≠ trong th·ªùi gian thu√™ (nƒÉm 1-<span id="formula-years-fin">4</span>):</li>
                            <li style="padding-left: 20px;">‚Ä¢ Ti·ªÅn ƒëi·ªán: <span id="formula-electric-fin">76.0</span> tri·ªáu/th√°ng</li>
                            <li style="padding-left: 20px;">‚Ä¢ Ph√≠ b·∫£o tr√¨: <span id="formula-maint-fin">55.0</span> tri·ªáu/th√°ng</li>
                            <li style="padding-left: 20px;">‚Ä¢ Ph√≠ qu·∫£n l√Ω: <span id="formula-mgmt-fin">2.0</span> tri·ªáu/th√°ng</li>
                            <li style="padding-left: 20px;"><strong>‚Ä¢ T·ªïng: <span id="formula-monthly-fin">155.0</span> tri·ªáu/th√°ng</strong></li>
                            <li>Gi√° mua l·∫°i (nƒÉm <span id="formula-years-fin-2">4</span>): <span id="formula-residual">10</span>% √ó CapEx = <span id="formula-residual-amount">110.0</span> tri·ªáu</li>
                            <li>Chi ph√≠ sau thu√™ (nƒÉm <span id="formula-years-fin-3">5</span>-<span id="formula-comparison-period-2">10</span>): <span id="formula-post-lease">135.0</span> tri·ªáu/th√°ng</li>
                            <li><strong>Kh√¥ng c√≥ cam k·∫øt ti·∫øt ki·ªám nƒÉng l∆∞·ª£ng</strong> (t·ª± v·∫≠n h√†nh)</li>
                            <li>Th·ªùi gian so s√°nh: <span id="formula-comparison-period-fin">10</span> nƒÉm</li>
                        </ul>
                    </div>
                    
                    <div class="formula-item">
                        <h4>3. Thu√™ v·∫≠n h√†nh (BenKon)</h4>
                        <p><strong>NPV = Deposit + PV(Chi ph√≠ h√†ng th√°ng)</strong></p>
                        <ul>
                            <li>Deposit ban ƒë·∫ßu: <span id="formula-deposit-oper">10</span>% √ó <span id="formula-capex-3">1,100.0</span> = <span id="formula-deposit-oper-amount">110.0</span> tri·ªáu</li>
                            <li><strong>Cam k·∫øt ti·∫øt ki·ªám nƒÉng l∆∞·ª£ng: <span id="formula-saving">20</span>% baseline</strong></li>
                            <li>Chi ph√≠ h√†ng th√°ng:</li>
                            <li style="padding-left: 20px;">‚Ä¢ Ti·ªÅn ƒëi·ªán (sau ti·∫øt ki·ªám): <span id="formula-electric-oper">60.8</span> tri·ªáu/th√°ng</li>
                            <li style="padding-left: 20px;">‚Ä¢ Ph√≠ thu√™: <span id="formula-oper-rent-detail">2.5</span>% √ó <span id="formula-capex-oper">1,100.0</span> = <span id="formula-rent-amount">27.5</span> tri·ªáu/th√°ng</li>
                            <li style="padding-left: 20px;">‚Ä¢ Ph√≠ b·∫£o tr√¨: <span id="formula-maint-oper">7.5</span> tri·ªáu/th√°ng</li>
                            <li style="padding-left: 20px;">‚Ä¢ Ph√≠ t·ªëi ∆∞u: <span id="formula-optimize-fee">199</span>k √ó <span id="formula-units">20</span> m√°y = <span id="formula-optimize">3.98</span> tri·ªáu/th√°ng</li>
                            <li style="padding-left: 20px;"><strong>‚Ä¢ T·ªïng: <span id="formula-monthly-oper">99.4</span> tri·ªáu/th√°ng</strong></li>
                            <li>Th·ªùi h·∫°n thu√™: <span id="formula-years-2">7</span> nƒÉm</li>
                            <li>Th·ªùi gian so s√°nh: <span id="formula-comparison-period-oper">10</span> nƒÉm</li>
                        </ul>
                    </div>
                </div>
                
                <div class="pv-formula">
                    <h4>C√¥ng th·ª©c Present Value (PV)</h4>
                    <p><strong>PV = A √ó [1 - (1+r)^(-n)] / r</strong></p>
                    <ul>
                        <li>A = Annuity (chi ph√≠ h√†ng th√°ng)</li>
                        <li>r = L√£i su·∫•t th√°ng = (1 + l√£i su·∫•t nƒÉm)^(1/12) - 1</li>
                        <li>n = S·ªë th√°ng = NƒÉm √ó 12</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="footer">
            <strong>BenKon</strong> ‚Äì Cooling Smarter, Saving Together
        </div>
    </div>

    <script>
        // Load saved values from localStorage
        window.addEventListener('load', () => {
            console.log('Page loaded, initializing...');
            const savedData = localStorage.getItem('benkonNPVData');
            if (savedData) {
                const data = JSON.parse(savedData);
                Object.keys(data).forEach(key => {
                    const input = document.getElementById(key);
                    if (input) input.value = data[key];
                });
            }
            
            // Initialize management fee displays
            updateManagementFeeDisplays();
            
            // Ensure formula notes are hidden on initial load
            document.getElementById('formulaPlaceholder').style.display = 'block';
            document.getElementById('formulaNotes').setAttribute('style', 'display:none !important;');
            
            // Simple initialization - no auto-calculation
            console.log('Page initialization complete');
        });

        // Save values to localStorage
        function saveToLocalStorage() {
            const inputs = ['capex', 'electric', 'saving', 'discount', 'years', 'years-fin', 'fin-interest', 
                          'aircon-units', 'optimize-fee-per-ac', 'deposit', 'deposit-oper', 'residual-value', 'oper-rent-pct', 
                          'premium-maint-pct', 'current-maint', 'management-fee', 'oper-optimize', 'buy-mgmt', 'fin-mgmt'];
            const data = {};
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) data[id] = element.value;
            });
            localStorage.setItem('benkonNPVData', JSON.stringify(data));
        }

        // Calculate NPV for annuity
        function calculatePV(monthlyPayment, annualRate, years) {
            // Handle edge cases
            if (!monthlyPayment || isNaN(monthlyPayment)) return 0;
            if (!annualRate || isNaN(annualRate)) return monthlyPayment * years * 12;
            if (!years || isNaN(years)) return 0;
            
            const monthlyRate = Math.pow(1 + annualRate / 100, 1/12) - 1;
            const months = years * 12;
            
            // If rate is effectively zero, return simple multiplication
            if (Math.abs(monthlyRate) < 0.000001) {
                return monthlyPayment * months;
            }
            
            return monthlyPayment * (1 - Math.pow(1 + monthlyRate, -months)) / monthlyRate;
        }

        // Format number to millions VND with 1 decimal place
        function formatMillion(value) {
            return new Intl.NumberFormat('vi-VN', {
                minimumFractionDigits: 1,
                maximumFractionDigits: 1
            }).format(value) + ' tri·ªáu';
        }

        // Format number for chart
        function formatChartMillion(value) {
            return new Intl.NumberFormat('vi-VN').format(Math.round(value));
        }

        // Main calculation function
        function calculate() {
            console.log('=== CALCULATE FUNCTION STARTED ===');
            saveToLocalStorage();
            
            // Get input values - check if elements exist first
            const capexEl = document.getElementById('capex');
            const electricEl = document.getElementById('electric');
            const savingEl = document.getElementById('saving');
            const discountEl = document.getElementById('discount');
            const yearsEl = document.getElementById('years');
            const yearsFinEl = document.getElementById('years-fin');
            
            if (!capexEl || !electricEl || !savingEl || !discountEl || !yearsEl || !yearsFinEl) {
                console.error('Missing input elements!', {
                    capex: !!capexEl, electric: !!electricEl, saving: !!savingEl, 
                    discount: !!discountEl, years: !!yearsEl, yearsFin: !!yearsFinEl
                });
                alert('Error: Some input fields are missing. Please refresh the page.');
                return;
            }
            
            const capex = parseFloat(capexEl.value);
            const electric = parseFloat(electricEl.value);
            const saving = parseFloat(savingEl.value) / 100;
            const discount = parseFloat(discountEl.value);
            const years = parseFloat(yearsEl.value); // BenKon lease period
            const yearsFin = parseFloat(yearsFinEl.value);
            
            console.log('Input values:', { capex, electric, saving, discount, years, yearsFin });
            const finInterest = parseFloat(document.getElementById('fin-interest').value);
            const airconUnits = parseFloat(document.getElementById('aircon-units').value);
            const depositPct = parseFloat(document.getElementById('deposit').value) / 100;
            const depositOperPct = parseFloat(document.getElementById('deposit-oper').value) / 100;
            const residualPct = parseFloat(document.getElementById('residual-value').value) / 100;
            
            // Get rental percentages
            const operRentPct = parseFloat(document.getElementById('oper-rent-pct').value) / 100;
            
            // Get maintenance costs
            const premiumMaintPct = parseFloat(document.getElementById('premium-maint-pct').value) / 100;
            const currentMaint = parseFloat(document.getElementById('current-maint').value);
            const premiumMaintMonthly = capex * premiumMaintPct / 12;
            const managementFee = parseFloat(document.getElementById('management-fee').value);
            const buyMgmt = managementFee;
            const finMgmt = managementFee;
            
            // Get optimization fee per AC and calculate total monthly cost
            const optimizeFeePerAC = parseFloat(document.getElementById('optimize-fee-per-ac').value) / 1000; // Convert from thousands to millions
            const optimizeCostMonthly = airconUnits * optimizeFeePerAC;
            
            // Update optimization cost display first
            document.getElementById('oper-optimize').value = optimizeCostMonthly.toFixed(1);
            const operOptimize = optimizeCostMonthly;

            // Calculate values
            const electricAfter = electric * (1 - saving);
            const operRentMonthly = capex * operRentPct;
            
            // Calculate financial lease payment using PMT formula
            // PMT = P * r * (1 + r)^n / ((1 + r)^n - 1)
            // Where P = Principal (CapEx - Deposit), r = monthly rate, n = months
            const principalFin = capex * (1 - depositPct);
            const monthlyRateFin = finInterest / 100 / 12;
            const monthsFin = yearsFin * 12;
            let finRentMonthly;
            
            if (monthlyRateFin === 0) {
                finRentMonthly = principalFin / monthsFin;
            } else {
                finRentMonthly = principalFin * monthlyRateFin * Math.pow(1 + monthlyRateFin, monthsFin) / 
                                 (Math.pow(1 + monthlyRateFin, monthsFin) - 1);
            }
            
            // Update the percentage display
            const finRentPct = (finRentMonthly / capex) * 100;
            document.getElementById('fin-rent-pct').value = finRentPct.toFixed(2);
            
            const depositAmount = capex * depositPct;
            const depositOperAmount = capex * depositOperPct;

            
            // Update display values
            document.getElementById('buy-capex').textContent = formatMillion(capex);
            document.getElementById('oper-capex').textContent = formatMillion(depositOperAmount);
            document.getElementById('fin-capex').textContent = formatMillion(depositAmount);
            
            // Update maintenance display
            document.getElementById('buy-maint-display').textContent = currentMaint.toFixed(1) + ' tri·ªáu (hi·ªán t·∫°i)';
            document.getElementById('fin-maint-display').textContent = currentMaint.toFixed(1) + ' tri·ªáu';
            document.getElementById('oper-maint-display').textContent = premiumMaintMonthly.toFixed(1) + ' tri·ªáu (Premium)';
            
            document.getElementById('buy-electric').textContent = formatMillion(electric);
            document.getElementById('oper-electric').textContent = formatMillion(electricAfter);
            document.getElementById('fin-electric').textContent = formatMillion(electric);
            
            document.getElementById('buy-rent').textContent = formatMillion(0);
            document.getElementById('oper-rent').textContent = formatMillion(operRentMonthly);
            document.getElementById('fin-rent').textContent = formatMillion(finRentMonthly);

            // Calculate monthly totals
            const buyMonthly = electric + currentMaint + buyMgmt;
            const operMonthly = electricAfter + operRentMonthly + premiumMaintMonthly + operOptimize;
            const finMonthly = electric + finRentMonthly + currentMaint + finMgmt;
            
            // Debug log
            console.log('Debug calculations:', {
                electric, electricAfter, operRentMonthly, premiumMaintMonthly, operOptimize,
                buyMonthly, operMonthly, finMonthly,
                discount, years
            });
            
            document.getElementById('buy-monthly').textContent = formatMillion(buyMonthly);
            document.getElementById('fin-monthly').textContent = formatMillion(finMonthly);
            document.getElementById('oper-monthly').textContent = formatMillion(operMonthly);

            // Use a consistent comparison period (max of all periods for fair comparison)
            const maxComparisonPeriod = Math.max(years, yearsFin);
            
            // Calculate NPVs over the same comparison period
            const npvBuy = capex + calculatePV(buyMonthly, discount, maxComparisonPeriod);
            const npvOper = depositOperAmount + calculatePV(operMonthly, discount, maxComparisonPeriod);
            
            // Financial lease NPV calculation:
            // 1. Deposit upfront
            // 2. Monthly payments during lease period (yearsFin)
            // 3. Residual value payment at end of lease
            // 4. Operating costs after lease ends (years - yearsFin)
            
            const residualValue = capex * residualPct;
            const yearsAfterFinLease = maxComparisonPeriod - yearsFin;
            
            // After lease ends, customer owns equipment but still pays operating costs
            const postLeaseMonthly = electric + currentMaint + finMgmt;
            
            let npvFin;
            if (yearsAfterFinLease > 0) {
                // NPV = Deposit + Lease payments + Residual (discounted) + Post-lease operating costs
                const pvLease = calculatePV(finMonthly, discount, yearsFin);
                const pvResidual = residualValue / Math.pow(1 + discount/100, yearsFin);
                const pvPostLease = calculatePV(postLeaseMonthly, discount, yearsAfterFinLease) / Math.pow(1 + discount/100, yearsFin);
                npvFin = depositAmount + pvLease + pvResidual + pvPostLease;
            } else {
                // If lease period >= total period, no post-lease costs
                npvFin = depositAmount + calculatePV(finMonthly, discount, yearsFin) + 
                        residualValue / Math.pow(1 + discount/100, yearsFin);
            }

            // Update NPV display
            document.getElementById('buy-npv').textContent = formatMillion(npvBuy);
            document.getElementById('fin-npv').textContent = formatMillion(npvFin);
            document.getElementById('oper-npv').textContent = formatMillion(npvOper);
            
            // Update formula notes with error checking
            function safeSetTextContent(elementId, value) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = value;
                } else {
                    console.warn('Element not found:', elementId);
                }
            }
            
            safeSetTextContent('formula-capex', capex.toFixed(1));
            safeSetTextContent('formula-capex-2', capex.toFixed(1));
            safeSetTextContent('formula-capex-3', capex.toFixed(1));
            safeSetTextContent('formula-capex-oper', capex.toFixed(1));
            
            // Buy option details
            safeSetTextContent('formula-electric-buy', electric.toFixed(1));
            safeSetTextContent('formula-maint-buy', currentMaint.toFixed(1));
            safeSetTextContent('formula-mgmt-buy', buyMgmt.toFixed(1));
            safeSetTextContent('formula-monthly-buy', buyMonthly.toFixed(1));
            
            // Financial lease details
            safeSetTextContent('formula-deposit', (depositPct * 100).toFixed(0));
            safeSetTextContent('formula-deposit-2', (depositPct * 100).toFixed(0));
            safeSetTextContent('formula-deposit-amount', depositAmount.toFixed(1));
            safeSetTextContent('formula-principal', principalFin.toFixed(1));
            safeSetTextContent('formula-fin-interest', finInterest.toFixed(1));
            safeSetTextContent('formula-fin-rent', finRentMonthly.toFixed(1));
            safeSetTextContent('formula-electric-fin', electric.toFixed(1));
            safeSetTextContent('formula-maint-fin', currentMaint.toFixed(1));
            safeSetTextContent('formula-mgmt-fin', finMgmt.toFixed(1));
            safeSetTextContent('formula-monthly-fin', finMonthly.toFixed(1));
            safeSetTextContent('formula-residual', (residualPct * 100).toFixed(0));
            safeSetTextContent('formula-residual-amount', residualValue.toFixed(1));
            safeSetTextContent('formula-post-lease', postLeaseMonthly.toFixed(1));
            safeSetTextContent('formula-years-fin', yearsFin.toFixed(0));
            safeSetTextContent('formula-years-fin-2', yearsFin.toFixed(0));
            safeSetTextContent('formula-years-fin-3', (yearsFin + 1).toFixed(0));
            
            // BenKon operational lease details
            safeSetTextContent('formula-deposit-oper', (depositOperPct * 100).toFixed(0));
            safeSetTextContent('formula-deposit-oper-amount', depositOperAmount.toFixed(1));
            safeSetTextContent('formula-saving', (saving * 100).toFixed(0));
            safeSetTextContent('formula-electric-oper', electricAfter.toFixed(1));
            safeSetTextContent('formula-oper-rent-detail', (operRentPct * 100).toFixed(1));
            safeSetTextContent('formula-rent-amount', operRentMonthly.toFixed(1));
            safeSetTextContent('formula-maint-oper', premiumMaintMonthly.toFixed(1));
            safeSetTextContent('formula-units', airconUnits.toFixed(0));
            safeSetTextContent('formula-optimize-fee', (optimizeFeePerAC * 1000).toFixed(0));
            safeSetTextContent('formula-optimize', optimizeCostMonthly.toFixed(1));
            safeSetTextContent('formula-monthly-oper', operMonthly.toFixed(1));
            
            // General
            safeSetTextContent('formula-comparison-period', maxComparisonPeriod.toFixed(0));
            safeSetTextContent('formula-comparison-period-2', maxComparisonPeriod.toFixed(0));
            safeSetTextContent('formula-comparison-period-fin', maxComparisonPeriod.toFixed(0));
            safeSetTextContent('formula-comparison-period-oper', maxComparisonPeriod.toFixed(0));
            safeSetTextContent('formula-years-2', years.toFixed(0));
            
            // Find and mark winner
            const minNPV = Math.min(npvBuy, npvOper, npvFin);
            document.querySelectorAll('.npv-value').forEach(cell => {
                cell.classList.remove('winner-cell');
            });
            
            if (npvBuy === minNPV) {
                document.getElementById('buy-npv').classList.add('winner-cell');
            } else if (npvFin === minNPV) {
                document.getElementById('fin-npv').classList.add('winner-cell');
            } else {
                document.getElementById('oper-npv').classList.add('winner-cell');
            }

            // Display comprehensive evaluation
            const conclusion = document.getElementById('conclusion');
            const savingBuyOper = npvBuy - npvOper;
            const savingBuyFin = npvBuy - npvFin;
            const savingFinOper = npvFin - npvOper;
            
            // Calculate scores for each option based on criteria (max 100)
            const scores = {
                buy: 0,
                fin: 0,
                oper: 0
            };
            
            // Criteria weights (total = 100%)
            const weights = {
                npv: 0.30,
                stability: 0.25,
                capex: 0.25,
                energy: 0.20
            };
            
            // NPV scoring (lower NPV is better, max 30 points)
            const maxNPV = Math.max(npvBuy, npvFin, npvOper);
            const npvRange = maxNPV - minNPV;
            if (npvRange > 0) {
                scores.buy += weights.npv * 100 * (1 - (npvBuy - minNPV) / npvRange);
                scores.fin += weights.npv * 100 * (1 - (npvFin - minNPV) / npvRange);
                scores.oper += weights.npv * 100 * (1 - (npvOper - minNPV) / npvRange);
            } else {
                // All equal
                scores.buy += weights.npv * 100;
                scores.fin += weights.npv * 100;
                scores.oper += weights.npv * 100;
            }
            
            // Stability & risk scoring (max 25 points)
            // BenKon has best SLA and maintenance, Financial lease medium, Buy lowest
            scores.buy += weights.stability * 100 * 0.6;   // 60% score
            scores.fin += weights.stability * 100 * 0.7;   // 70% score
            scores.oper += weights.stability * 100 * 1.0;  // 100% score
            
            // CapEx scoring (lower initial investment is better, max 25 points)
            const capexBuy = capex;
            const capexFin = depositAmount;
            const capexOper = depositOperAmount;
            const maxCapex = Math.max(capexBuy, capexFin, capexOper);
            const minCapex = Math.min(capexBuy, capexFin, capexOper);
            const capexRange = maxCapex - minCapex;
            if (capexRange > 0) {
                scores.buy += weights.capex * 100 * (1 - (capexBuy - minCapex) / capexRange);
                scores.fin += weights.capex * 100 * (1 - (capexFin - minCapex) / capexRange);
                scores.oper += weights.capex * 100 * (1 - (capexOper - minCapex) / capexRange);
            } else {
                scores.buy += weights.capex * 100;
                scores.fin += weights.capex * 100;
                scores.oper += weights.capex * 100;
            }
            
            // Energy efficiency & data scoring (max 20 points)
            // Only BenKon provides energy optimization and data
            scores.buy += weights.energy * 100 * 0.3;   // 30% - no optimization
            scores.fin += weights.energy * 100 * 0.3;   // 30% - no optimization  
            scores.oper += weights.energy * 100 * 1.0;  // 100% - full optimization with monitoring
            
            // Determine recommendation
            let recommendation = '';
            let recommendedOption = '';
            if (scores.oper >= scores.fin && scores.oper >= scores.buy) {
                recommendedOption = 'BenKon';
                recommendation = `Thu√™ v·∫≠n h√†nh BenKon - Ti·∫øt ki·ªám ${formatMillion(savingBuyOper)} (${Math.round(savingBuyOper/npvBuy*100)}%) so v·ªõi t·ª± ƒë·∫ßu t∆∞`;
            } else if (scores.fin >= scores.buy) {
                recommendedOption = 'Thu√™ t√†i ch√≠nh';
                recommendation = `Thu√™ t√†i ch√≠nh - Ti·∫øt ki·ªám ${formatMillion(savingBuyFin)} (${Math.round(savingBuyFin/npvBuy*100)}%) so v·ªõi t·ª± ƒë·∫ßu t∆∞`;
            } else {
                recommendedOption = 'T·ª± ƒë·∫ßu t∆∞';
                recommendation = `T·ª± ƒë·∫ßu t∆∞ - Chi ph√≠ th·∫•p nh·∫•t trong v√≤ng ƒë·ªùi ${years} nƒÉm`;
            }
            
            let conclusionText = `
                <h3>üîπ Top 4 ti√™u ch√≠ ƒë√°nh gi√° tr·ªçng y·∫øu</h3>
                
                <table class="evaluation-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="width: 30%;">Ti√™u ch√≠</th>
                            <th style="width: 65%;">L√Ω do ch·ªçn</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="criteria-number">1</span></td>
                            <td><strong>üí∞ T·ªïng chi ph√≠ v√≤ng ƒë·ªùi (NPV)</strong></td>
                            <td>Th·ªÉ hi·ªán hi·ªáu qu·∫£ t√†i ch√≠nh to√†n chu k·ª≥ ‚Äî l√† chu·∫©n m·ª±c ƒë·∫ßu ti√™n khi so s√°nh m√¥ h√¨nh mua, thu√™ t√†i ch√≠nh v√† thu√™ v·∫≠n h√†nh. D√π ch√™nh l·ªách kh√¥ng l·ªõn, ƒë√¢y v·∫´n l√† ch·ªâ s·ªë n·ªÅn t·∫£ng ƒë·ªÉ ƒë√°nh gi√° gi√° tr·ªã th·∫≠t.</td>
                        </tr>
                        <tr>
                            <td><span class="criteria-number">2</span></td>
                            <td><strong>üèóÔ∏è ƒê·ªô ·ªïn ƒë·ªãnh & r·ªßi ro v·∫≠n h√†nh</strong></td>
                            <td>M·ªçi ph∆∞∆°ng √°n ti·∫øt ki·ªám chi ph√≠ ƒë·ªÅu m·∫•t √Ω nghƒ©a n·∫øu h·ªá th·ªëng kh√¥ng ·ªïn ƒë·ªãnh ho·∫∑c g√¢y downtime. Ti√™u ch√≠ n√†y bao g·ªìm: ƒë·ªô tin c·∫≠y k·ªπ thu·∫≠t, th·ªùi gian ph·∫£n h·ªìi, ch·∫•t l∆∞·ª£ng b·∫£o tr√¨, v√† cam k·∫øt SLA.</td>
                        </tr>
                        <tr>
                            <td><span class="criteria-number">3</span></td>
                            <td><strong>‚öôÔ∏è √Åp l·ª±c v·ªën ƒë·∫ßu t∆∞ ban ƒë·∫ßu (CapEx)</strong></td>
                            <td>·∫¢nh h∆∞·ªüng tr·ª±c ti·∫øp ƒë·∫øn kh·∫£ nƒÉng ph√¢n b·ªï v·ªën cho c√°c d·ª± √°n chi·∫øn l∆∞·ª£c kh√°c. Ph∆∞∆°ng √°n "asset-light" (nh∆∞ BenKon CaaS) gi√∫p t·ªëi ∆∞u ROIC v√† gi·∫£m r·ªßi ro t√†i s·∫£n d√†i h·∫°n.</td>
                        </tr>
                        <tr>
                            <td><span class="criteria-number">4</span></td>
                            <td><strong>üîã Hi·ªáu su·∫•t nƒÉng l∆∞·ª£ng & d·ªØ li·ªáu v·∫≠n h√†nh</strong></td>
                            <td>Kh√¥ng ch·ªâ mang l·∫°i ti·∫øt ki·ªám ƒëi·ªán m√† c√≤n cung c·∫•p d·ªØ li·ªáu cho qu·∫£n tr·ªã nƒÉng l∆∞·ª£ng, ESG v√† c√°c b√°o c√°o sustainability. ƒê√¢y l√† l·ª£i √≠ch d√†i h·∫°n gi√∫p chuy·ªÉn ƒë·ªïi m√¥ h√¨nh v·∫≠n h√†nh sang data-driven.</td>
                        </tr>
                    </tbody>
                </table>
            `;
            
            conclusion.innerHTML = conclusionText;
            conclusion.style.display = 'block';

            // Update sensitivity chart with delay to ensure DOM is ready
            setTimeout(() => {
                console.log('=== CHART UPDATE STARTED ===');
                console.log('Chart.js available:', typeof Chart !== 'undefined');
                
                // Hide the chart placeholder
                const placeholder = document.getElementById('chartPlaceholder');
                if (placeholder) {
                    console.log('Hiding chart placeholder');
                    placeholder.style.display = 'none';
                }
                
                if (typeof Chart !== 'undefined') {
                    console.log('Calling updateSensitivityChart...');
                    updateSensitivityChart();
                } else {
                    console.log('Chart.js not ready, showing error message');
                    alert('Chart.js not loaded. Please refresh the page.');
                }
            }, 200);

            // Generate cash flow table
            console.log('About to call generateCashFlowTable...');
            generateCashFlowTable();
            console.log('generateCashFlowTable completed');
            
            // Show comparison table, formula notes section and hide placeholders
            document.getElementById('comparisonTablePlaceholder').style.display = 'none';
            document.getElementById('comparisonTableContainer').style.display = 'block';
            document.getElementById('formulaPlaceholder').style.display = 'none';
            document.getElementById('formulaNotes').setAttribute('style', 'display:block !important;');
        }

        // Sensitivity analysis chart
        let sensitivityChart = null;
        let capexChart = null;
        let monthlyCashFlowChart = null;

        function updateSensitivityChart() {
            console.log('=== updateSensitivityChart STARTED ===');
            
            // Check Chart.js availability first
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not available for sensitivity chart');
                alert('Chart.js is not loaded. Please refresh the page.');
                return;
            }
            
            console.log('Chart.js is available, proceeding with chart creation...');

            try {
                const capex = parseFloat(document.getElementById('capex').value);
                const electric = parseFloat(document.getElementById('electric').value);
                const discount = parseFloat(document.getElementById('discount').value);
                const years = parseFloat(document.getElementById('years').value);
                const yearsFin = parseFloat(document.getElementById('years-fin').value);
                const finInterest = parseFloat(document.getElementById('fin-interest').value);
                const airconUnits = parseFloat(document.getElementById('aircon-units').value);
                const depositPct = parseFloat(document.getElementById('deposit').value) / 100;
                const depositOperPct = parseFloat(document.getElementById('deposit-oper').value) / 100;
                const residualPct = parseFloat(document.getElementById('residual-value').value) / 100;
                
                console.log('Chart inputs:', {
                    capex, electric, discount, years, yearsFin, 
                    finInterest, airconUnits, depositPct, depositOperPct, residualPct
                });
            
            const operRentPct = parseFloat(document.getElementById('oper-rent-pct').value) / 100;
            
            const premiumMaintPct = parseFloat(document.getElementById('premium-maint-pct').value) / 100;
            const currentMaint = parseFloat(document.getElementById('current-maint').value);
            const premiumMaintMonthly = capex * premiumMaintPct / 12;
            const managementFee = parseFloat(document.getElementById('management-fee').value);
            const buyMgmt = managementFee;
            const finMgmt = managementFee;
            
            // Calculate optimization cost
            const optimizeFeePerAC = parseFloat(document.getElementById('optimize-fee-per-ac').value) / 1000; // Convert from thousands to millions
            const operOptimize = airconUnits * optimizeFeePerAC;

            // Generate data points for different saving rates
            const savingRates = [];
            const deltaNPVOper = [];
            const deltaNPVFin = [];
            
            console.log('Starting sensitivity calculation...');

            for (let s = 0; s <= 35; s += 2.5) {
                savingRates.push(s);
                const savingRate = s / 100;
                
                // Recalculate NPVs for this saving rate
                const electricAfter = electric * (1 - savingRate);
                const operRentMonthly = capex * operRentPct;
                
                // Recalculate financial lease payment
                const principalFin = capex * (1 - depositPct);
                const monthlyRateFin = finInterest / 100 / 12;
                const monthsFin = yearsFin * 12;
                let finRentMonthly;
                
                if (monthlyRateFin === 0) {
                    finRentMonthly = principalFin / monthsFin;
                } else {
                    finRentMonthly = principalFin * monthlyRateFin * Math.pow(1 + monthlyRateFin, monthsFin) / 
                                     (Math.pow(1 + monthlyRateFin, monthsFin) - 1);
                }
                
                const depositAmount = capex * depositPct;
                const depositOperAmount = capex * depositOperPct;

                // Use consistent comparison period like main calculation
                const maxComparisonPeriod = Math.max(years, yearsFin);
                
                // Buy model: no energy saving
                const buyMonthly = electric + currentMaint + buyMgmt;
                const npvBuy = capex + calculatePV(buyMonthly, discount, maxComparisonPeriod);

                // Operational lease: has energy saving
                const operMonthly = electricAfter + operRentMonthly + premiumMaintMonthly + operOptimize;
                const npvOper = depositOperAmount + calculatePV(operMonthly, discount, maxComparisonPeriod);

                // Financial lease: NO energy saving (same as buy for electricity)
                const finMonthly = electric + finRentMonthly + currentMaint + finMgmt;
                
                // Calculate NPV with residual value and post-lease costs like main calculation
                const residualValue = capex * residualPct;
                const yearsAfterFinLease = maxComparisonPeriod - yearsFin;
                const postLeaseMonthly = electric + currentMaint + finMgmt;
                
                let npvFin;
                if (yearsAfterFinLease > 0) {
                    const pvLease = calculatePV(finMonthly, discount, yearsFin);
                    const pvResidual = residualValue / Math.pow(1 + discount/100, yearsFin);
                    const pvPostLease = calculatePV(postLeaseMonthly, discount, yearsAfterFinLease) / Math.pow(1 + discount/100, yearsFin);
                    npvFin = depositAmount + pvLease + pvResidual + pvPostLease;
                } else {
                    npvFin = depositAmount + calculatePV(finMonthly, discount, yearsFin) + 
                            residualValue / Math.pow(1 + discount/100, yearsFin);
                }

                const deltaNPVOperValue = Math.round(npvBuy - npvOper);
                const deltaNPVFinValue = Math.round(npvBuy - npvFin);
                
                deltaNPVOper.push(deltaNPVOperValue);
                deltaNPVFin.push(deltaNPVFinValue);
                
                // Debug for 0% saving
                if (s === 0) {
                    console.log('At 0% saving:', {
                        npvBuy: npvBuy.toFixed(1),
                        npvOper: npvOper.toFixed(1), 
                        npvFin: npvFin.toFixed(1),
                        deltaNPVOper: deltaNPVOperValue,
                        deltaNPVFin: deltaNPVFinValue,
                        buyMonthly: buyMonthly.toFixed(1),
                        operMonthly: operMonthly.toFixed(1),
                        finMonthly: finMonthly.toFixed(1)
                    });
                }
            }

            console.log('Looking for canvas element...');
            const ctx = document.getElementById('sensitivityChart');
            if (!ctx) {
                console.error('Canvas element sensitivityChart not found');
                alert('Canvas element not found');
                return;
            }
            console.log('Canvas element found:', ctx);
            
            const context = ctx.getContext('2d');
            console.log('Canvas context:', context);
            
            if (sensitivityChart) {
                console.log('Destroying existing chart');
                sensitivityChart.destroy();
            }

            console.log('Creating chart with data:', {
                savingRates: savingRates.length + ' points',
                deltaNPVOper: deltaNPVOper.length + ' points',
                deltaNPVFin: deltaNPVFin.length + ' points'
            });

            console.log('About to create Chart...');
            sensitivityChart = new Chart(context, {
                type: 'line',
                data: {
                    labels: savingRates.map(s => s + '%'),
                    datasets: [
                        {
                            label: 'Thu√™ t√†i ch√≠nh vs T·ª± ƒë·∫ßu t∆∞ (ŒîNPV)',
                            data: deltaNPVFin,
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#764ba2'
                        },
                        {
                            label: 'Thu√™ v·∫≠n h√†nh BenKon vs T·ª± ƒë·∫ßu t∆∞ (ŒîNPV)',
                            data: deltaNPVOper,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#667eea'
                        },
                        {
                            label: 'ƒêi·ªÉm h√≤a v·ªën',
                            data: new Array(savingRates.length).fill(0),
                            borderColor: '#dc3545',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '·∫¢nh h∆∞·ªüng c·ªßa ti·∫øt ki·ªám nƒÉng l∆∞·ª£ng ƒë·∫øn NPV',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label && label !== 'ƒêi·ªÉm h√≤a v·ªën') {
                                        label += ': ';
                                        const value = context.parsed.y;
                                        if (value > 0) {
                                            label += '+' + formatChartMillion(value) + ' tri·ªáu (ti·∫øt ki·ªám)';
                                        } else if (value < 0) {
                                            label += formatChartMillion(value) + ' tri·ªáu (l·ªó)';
                                        } else {
                                            label += '0 tri·ªáu (h√≤a v·ªën)';
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Cam k·∫øt ti·∫øt ki·ªám nƒÉng l∆∞·ª£ng BenKon (%)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'ŒîNPV so v·ªõi t·ª± ƒë·∫ßu t∆∞ (tri·ªáu VNƒê)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value > 0) return '+' + formatChartMillion(value);
                                    return formatChartMillion(value);
                                },
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
            
            console.log('Chart creation completed successfully!', sensitivityChart);
            
            // Create CapEx chart
            createCapExChart();
            
            // Create monthly cash flow chart
            createMonthlyCashFlowChart();
            } catch (error) {
                console.error('Sensitivity chart error:', error);
                alert('Chart error: ' + error.message);
            } finally {
                document.getElementById('chartPlaceholder').style.display = 'none';
            }
        }

        function createCapExChart() {
            console.log('=== createCapExChart STARTED ===');
            
            try {
                // Get input values
                const capex = parseFloat(document.getElementById('capex').value);
                const depositPct = parseFloat(document.getElementById('deposit').value) / 100;
                const depositOperPct = parseFloat(document.getElementById('deposit-oper').value) / 100;
                
                // Calculate initial investments (CapEx) for each option
                const buyCapEx = capex; // Full CAPEX upfront
                const finCapEx = capex * depositPct; // Only deposit for financial lease
                const operCapEx = capex * depositOperPct; // Only deposit for operational lease
                
                console.log('CapEx data prepared:', {
                    buyCapEx,
                    finCapEx,
                    operCapEx
                });
                
                // Create chart
                const ctx = document.getElementById('capexChart');
                if (!ctx) {
                    console.error('Canvas element capexChart not found');
                    return;
                }
                
                const context = ctx.getContext('2d');
                
                if (capexChart) {
                    console.log('Destroying existing CapEx chart');
                    capexChart.destroy();
                }
                
                console.log('Creating CapEx chart...');
                capexChart = new Chart(context, {
                    type: 'bar',
                    data: {
                        labels: ['T·ª± ƒë·∫ßu t∆∞', 'Thu√™ t√†i ch√≠nh', 'BenKon (Thu√™ v·∫≠n h√†nh)'],
                        datasets: [
                            {
                                label: 'V·ªën ƒë·∫ßu t∆∞ ban ƒë·∫ßu (CapEx)',
                                data: [buyCapEx, finCapEx, operCapEx],
                                backgroundColor: [
                                    'rgba(220, 53, 69, 0.8)',
                                    'rgba(118, 75, 162, 0.8)', 
                                    'rgba(102, 126, 234, 0.8)'
                                ],
                                borderColor: [
                                    '#dc3545',
                                    '#764ba2',
                                    '#667eea'
                                ],
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'So s√°nh v·ªën ƒë·∫ßu t∆∞ ban ƒë·∫ßu (CapEx)',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        return 'CapEx: ' + formatMillion(value) + ' tri·ªáu VNƒê';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Ph∆∞∆°ng √°n ƒë·∫ßu t∆∞',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'V·ªën ƒë·∫ßu t∆∞ (tri·ªáu VNƒê)',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatChartMillion(value);
                                    },
                                    font: {
                                        size: 12
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
                
                console.log('CapEx chart created successfully!', capexChart);
                
            } catch (error) {
                console.error('CapEx chart error:', error);
                alert('CapEx chart error: ' + error.message);
            } finally {
                document.getElementById('capexChartPlaceholder').style.display = 'none';
            }
        }

        function createMonthlyCashFlowChart() {
            console.log('=== createMonthlyCashFlowChart STARTED ===');
            
            try {
                // Get input values
                const capex = parseFloat(document.getElementById('capex').value);
                const electric = parseFloat(document.getElementById('electric').value);
                const saving = parseFloat(document.getElementById('saving').value) / 100;
                const discount = parseFloat(document.getElementById('discount').value);
                const years = parseFloat(document.getElementById('years').value);
                const yearsFin = parseFloat(document.getElementById('years-fin').value);
                const finInterest = parseFloat(document.getElementById('fin-interest').value);
                const airconUnits = parseFloat(document.getElementById('aircon-units').value);
                const depositPct = parseFloat(document.getElementById('deposit').value) / 100;
                const depositOperPct = parseFloat(document.getElementById('deposit-oper').value) / 100;
                const residualPct = parseFloat(document.getElementById('residual-value').value) / 100;
                
                const operRentPct = parseFloat(document.getElementById('oper-rent-pct').value) / 100;
                const premiumMaintPct = parseFloat(document.getElementById('premium-maint-pct').value) / 100;
                const currentMaint = parseFloat(document.getElementById('current-maint').value);
                const premiumMaintMonthly = capex * premiumMaintPct / 12;
                const buyMgmt = parseFloat(document.getElementById('buy-mgmt').value);
                const finMgmt = parseFloat(document.getElementById('fin-mgmt').value);
                const optimizeFeePerAC = parseFloat(document.getElementById('optimize-fee-per-ac').value) / 1000;
                
                // Reuse maxComparisonPeriod from main scope
                
                // Calculate monthly costs
                const electricAfter = electric * (1 - saving);
                const buyMonthly = electric + currentMaint + buyMgmt; // Current maintenance for self-investment
                const operRentMonthly = capex * operRentPct;
                const operOptimize = airconUnits * optimizeFeePerAC;
                const operMonthly = electricAfter + operRentMonthly + premiumMaintMonthly + operOptimize; // Premium maintenance for BenKon
                
                // Financial lease calculations
                const depositAmount = capex * depositPct;
                const principalFin = capex * (1 - depositPct);
                const monthlyRateFin = finInterest / 100 / 12;
                const monthsFin = yearsFin * 12;
                let finRentMonthly;
                
                if (monthlyRateFin === 0) {
                    finRentMonthly = principalFin / monthsFin;
                } else {
                    finRentMonthly = principalFin * monthlyRateFin * Math.pow(1 + monthlyRateFin, monthsFin) / 
                                     (Math.pow(1 + monthlyRateFin, monthsFin) - 1);
                }
                
                const finMonthly = electric + finRentMonthly + currentMaint + finMgmt; // Current maintenance for financial lease
                const residualValue = capex * residualPct;
                const postLeaseMonthly = electric + currentMaint + finMgmt;
                
                // Generate cash flow data for 2 groups: lease period and post-lease period
                const finLeaseMonths = yearsFin * 12;
                const maxComparisonPeriod = Math.max(years, yearsFin);
                
                const month_labels = [];
                const buyMonthlyCashFlow = [];
                const finMonthlyCashFlow = [];
                const operMonthlyCashFlow = [];
                
                // Group 1: Months 1 to financial lease end
                month_labels.push(`Th√°ng 1-${finLeaseMonths}`);
                buyMonthlyCashFlow.push(buyMonthly);
                finMonthlyCashFlow.push(finMonthly);
                operMonthlyCashFlow.push(operMonthly);
                
                // Group 2: Post-lease months (if comparison period extends beyond financial lease)
                if (maxComparisonPeriod > yearsFin) {
                    const postLeaseStart = finLeaseMonths + 1;
                    const postLeaseEnd = maxComparisonPeriod * 12;
                    month_labels.push(`Th√°ng ${postLeaseStart}-${postLeaseEnd}`);
                    buyMonthlyCashFlow.push(buyMonthly);
                    finMonthlyCashFlow.push(postLeaseMonthly);
                    
                    // Check if BenKon lease is still active in this period
                    if (years > yearsFin) {
                        // BenKon continues if its lease period extends beyond financial lease
                        operMonthlyCashFlow.push(operMonthly);
                    } else {
                        // BenKon has ended
                        operMonthlyCashFlow.push(0);
                    }
                }
                
                console.log('Monthly cash flow data prepared:', {
                    month_labels,
                    buyMonthlyCashFlow,
                    finMonthlyCashFlow,
                    operMonthlyCashFlow
                });
                
                // Create chart
                const ctx = document.getElementById('monthlyCashFlowChart');
                if (!ctx) {
                    console.error('Canvas element monthlyCashFlowChart not found');
                    return;
                }
                
                const context = ctx.getContext('2d');
                
                if (monthlyCashFlowChart) {
                    console.log('Destroying existing monthly cash flow chart');
                    monthlyCashFlowChart.destroy();
                }
                
                console.log('Creating monthly cash flow chart...');
                monthlyCashFlowChart = new Chart(context, {
                    type: 'bar',
                    data: {
                        labels: month_labels,
                        datasets: [
                            {
                                label: 'T·ª± ƒë·∫ßu t∆∞',
                                data: buyMonthlyCashFlow,
                                backgroundColor: 'rgba(220, 53, 69, 0.8)',
                                borderColor: '#dc3545',
                                borderWidth: 1
                            },
                            {
                                label: 'Thu√™ t√†i ch√≠nh',
                                data: finMonthlyCashFlow,
                                backgroundColor: 'rgba(118, 75, 162, 0.8)',
                                borderColor: '#764ba2',
                                borderWidth: 1
                            },
                            {
                                label: 'BenKon',
                                data: operMonthlyCashFlow,
                                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                borderColor: '#667eea',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Chi ph√≠ v·∫≠n h√†nh OpEx qua c√°c th√°ng',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        return context.dataset.label + ': ' + formatMillion(value) + ' tri·ªáu VNƒê';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Th·ªùi gian',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Chi ph√≠ v·∫≠n h√†nh (tri·ªáu VNƒê)',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatChartMillion(value);
                                    },
                                    font: {
                                        size: 12
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
                
                console.log('Monthly cash flow chart created successfully!', monthlyCashFlowChart);
                
            } catch (error) {
                console.error('Monthly cash flow chart error:', error);
                alert('Monthly cash flow chart error: ' + error.message);
            } finally {
                document.getElementById('monthlyCashFlowChartPlaceholder').style.display = 'none';
            }
        }

        // Generate cash flow table
        function generateCashFlowTable() {
            console.log('generateCashFlowTable called');
            try {
            const capex = parseFloat(document.getElementById('capex').value);
            const electric = parseFloat(document.getElementById('electric').value);
            const saving = parseFloat(document.getElementById('saving').value) / 100;
            const discount = parseFloat(document.getElementById('discount').value);
            const years = parseFloat(document.getElementById('years').value); // BenKon lease period
            const yearsFin = parseFloat(document.getElementById('years-fin').value);
            const finInterest = parseFloat(document.getElementById('fin-interest').value);
            const airconUnits = parseFloat(document.getElementById('aircon-units').value);
            const depositPct = parseFloat(document.getElementById('deposit').value) / 100;
            const depositOperPct = parseFloat(document.getElementById('deposit-oper').value) / 100;
            const residualPct = parseFloat(document.getElementById('residual-value').value) / 100;
            const operRentPct = parseFloat(document.getElementById('oper-rent-pct').value) / 100;
            
            const premiumMaintPct = parseFloat(document.getElementById('premium-maint-pct').value) / 100;
            const currentMaint = parseFloat(document.getElementById('current-maint').value);
            const premiumMaintMonthly = capex * premiumMaintPct / 12;
            const managementFee = parseFloat(document.getElementById('management-fee').value);
            const buyMgmt = managementFee;
            const finMgmt = managementFee;
            const optimizeFeePerAC = parseFloat(document.getElementById('optimize-fee-per-ac').value) / 1000; // Convert from thousands to millions
            const operOptimize = airconUnits * optimizeFeePerAC;

            // Calculate values
            const electricAfter = electric * (1 - saving);
            const operRentMonthly = capex * operRentPct;
            const principalFin = capex * (1 - depositPct);
            const monthlyRateFin = finInterest / 100 / 12;
            const monthsFin = yearsFin * 12;
            
            let finRentMonthly;
            if (monthlyRateFin === 0) {
                finRentMonthly = principalFin / monthsFin;
            } else {
                finRentMonthly = principalFin * monthlyRateFin * Math.pow(1 + monthlyRateFin, monthsFin) / 
                                 (Math.pow(1 + monthlyRateFin, monthsFin) - 1);
            }

            const depositAmount = capex * depositPct;
            const depositOperAmount = capex * depositOperPct;
            const residualValue = capex * residualPct;

            // Monthly costs
            const buyMonthly = electric + currentMaint + buyMgmt;
            const operMonthly = electricAfter + operRentMonthly + premiumMaintMonthly + operOptimize;
            const finMonthly = electric + finRentMonthly + currentMaint + finMgmt; // Premium maintenance for financial lease
            const postLeaseMonthly = electric + currentMaint + finMgmt;

            let html = '';

            let totalBuy = 0, totalFin = 0, totalOper = 0;

            // Year 0 - Initial costs
            html += `
                <tr class="year-header">
                    <td style="font-weight: 600; background: #f8f9fa;">NƒÉm 0 (Ban ƒë·∫ßu)</td>
                    <td class="negative">-${formatNumber(capex)}</td>
                    <td class="negative">-${formatNumber(depositAmount)}</td>
                    <td class="negative">-${formatNumber(depositOperAmount)}</td>
                </tr>
                <tr style="font-size: 0.85em; color: #6c757d;">
                    <td style="padding-left: 25px;">‚Ä¢ CapEx ƒë·∫ßu t∆∞</td>
                    <td class="negative">-${formatNumber(capex)}</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                <tr style="font-size: 0.85em; color: #6c757d;">
                    <td style="padding-left: 25px;">‚Ä¢ Deposit (${(depositPct * 100).toFixed(0)}%)</td>
                    <td>-</td>
                    <td class="negative">-${formatNumber(depositAmount)}</td>
                    <td>-</td>
                </tr>
                <tr style="font-size: 0.85em; color: #6c757d;">
                    <td style="padding-left: 25px;">‚Ä¢ Deposit BenKon (${(depositOperPct * 100).toFixed(0)}%)</td>
                    <td>-</td>
                    <td>-</td>
                    <td class="negative">-${formatNumber(depositOperAmount)}</td>
                </tr>
            `;
            totalBuy += capex;
            totalFin += depositAmount;
            totalOper += depositOperAmount;

            // Use consistent comparison period for cash flow table
            const maxComparisonPeriod = Math.max(years, yearsFin);
            
            // Yearly cash flows with detailed breakdown
            for (let year = 1; year <= maxComparisonPeriod; year++) {
                // Buy option breakdown
                let buyElectric = electric * 12;
                let currentMaintYear = currentMaint * 12;
                let buyMgmtYear = buyMgmt * 12;
                let buyYearly = buyElectric + currentMaintYear + buyMgmtYear;

                // BenKon option breakdown (only for lease period)
                let operElectricYear = 0;
                let operRentYear = 0;
                let operMaintYear = 0;
                let operOptimizeYear = 0;
                let operYearly = 0;
                
                if (year <= years) {
                    // During BenKon lease period
                    operElectricYear = electricAfter * 12;
                    operRentYear = operRentMonthly * 12;
                    operMaintYear = premiumMaintMonthly * 12;
                    operOptimizeYear = operOptimize * 12;
                    operYearly = operElectricYear + operRentYear + operMaintYear + operOptimizeYear;
                } else {
                    // After BenKon lease ends, no costs (or could add post-lease costs if needed)
                    operYearly = 0;
                }

                // Financial lease breakdown
                let finYearly = 0;
                let finElectricYear = 0;
                let finRentYear = 0;
                let finMaintYear = 0;
                let finMgmtYear = 0;
                let finResidualYear = 0;

                if (year <= yearsFin) {
                    // During lease period
                    finElectricYear = electric * 12;
                    finRentYear = finRentMonthly * 12;
                    finMaintYear = currentMaint * 12;
                    finMgmtYear = finMgmt * 12;
                    finYearly = finElectricYear + finRentYear + finMaintYear + finMgmtYear;
                    
                    // Add residual value payment at end of lease
                    if (year === yearsFin) {
                        finResidualYear = residualValue;
                        finYearly += finResidualYear;
                    }
                } else {
                    // After lease period - post-lease operating costs
                    finElectricYear = electric * 12;
                    finMaintYear = currentMaint * 12;
                    finMgmtYear = finMgmt * 12;
                    finYearly = finElectricYear + finMaintYear + finMgmtYear;
                }

                html += `
                    <tr>
                        <td style="font-weight: 600; background: #f8f9fa;">NƒÉm ${year}</td>
                        <td class="negative">-${formatNumber(buyYearly)}</td>
                        <td class="negative">-${formatNumber(finYearly)}</td>
                        <td class="${operYearly > 0 ? 'negative' : ''}">${operYearly > 0 ? '-' + formatNumber(operYearly) : '-'}</td>
                    </tr>
                `;

                // Add detailed breakdown rows
                html += `
                    <tr style="font-size: 0.85em; color: #6c757d;">
                        <td style="padding-left: 25px;">‚Ä¢ Ti·ªÅn ƒëi·ªán (nƒÉm)</td>
                        <td class="negative">-${formatNumber(buyElectric)}</td>
                        <td class="negative">-${formatNumber(finElectricYear)}</td>
                        <td class="${operElectricYear > 0 ? 'negative' : ''}">${operElectricYear > 0 ? '-' + formatNumber(operElectricYear) : '-'}</td>
                    </tr>
                `;

                html += `
                    <tr style="font-size: 0.85em; color: #6c757d;">
                        <td style="padding-left: 25px;">‚Ä¢ Ph√≠ thu√™ (nƒÉm)</td>
                        <td>-</td>
                        <td class="${finRentYear > 0 ? 'negative' : ''}">${finRentYear > 0 ? '-' + formatNumber(finRentYear) : '-'}</td>
                        <td class="${operRentYear > 0 ? 'negative' : ''}">${operRentYear > 0 ? '-' + formatNumber(operRentYear) : '-'}</td>
                    </tr>
                `;

                html += `
                    <tr style="font-size: 0.85em; color: #6c757d;">
                        <td style="padding-left: 25px;">‚Ä¢ Ph√≠ b·∫£o tr√¨ (nƒÉm)</td>
                        <td class="negative">-${formatNumber(currentMaintYear)}</td>
                        <td class="${finMaintYear > 0 ? 'negative' : ''}">${finMaintYear > 0 ? '-' + formatNumber(finMaintYear) : '-'}</td>
                        <td class="${operMaintYear > 0 ? 'negative' : ''}">${operMaintYear > 0 ? '-' + formatNumber(operMaintYear) : '-'}</td>
                    </tr>
                    <tr style="font-size: 0.85em; color: #6c757d;">
                        <td style="padding-left: 25px;">‚Ä¢ Ph√≠ qu·∫£n l√Ω (nƒÉm)</td>
                        <td class="negative">-${formatNumber(buyMgmtYear)}</td>
                        <td class="${finMgmtYear > 0 ? 'negative' : ''}">${finMgmtYear > 0 ? '-' + formatNumber(finMgmtYear) : '-'}</td>
                        <td>-</td>
                    </tr>
                    <tr style="font-size: 0.85em; color: #6c757d;">
                        <td style="padding-left: 25px;">‚Ä¢ T·ªëi ∆∞u nƒÉng l∆∞·ª£ng (nƒÉm: ${(optimizeFeePerAC * 1000).toFixed(0)}k √ó ${airconUnits} m√°y)</td>
                        <td>-</td>
                        <td>-</td>
                        <td class="${operOptimizeYear > 0 ? 'negative' : ''}">${operOptimizeYear > 0 ? '-' + formatNumber(operOptimizeYear) : '-'}</td>
                    </tr>
                `;

                if (year === yearsFin && finResidualYear > 0) {
                    html += `
                        <tr style="font-size: 0.85em; color: #6c757d;">
                            <td style="padding-left: 25px;">‚Ä¢ Gi√° mua l·∫°i (${(residualPct * 100).toFixed(0)}%)</td>
                            <td>-</td>
                            <td class="negative">-${formatNumber(finResidualYear)}</td>
                            <td>-</td>
                        </tr>
                    `;
                }

                totalBuy += buyYearly;
                totalFin += finYearly;
                totalOper += operYearly;
            }

            // Total row
            html += `
                <tr class="total-row">
                    <td><strong>T·ªïng cash flow</strong></td>
                    <td class="negative"><strong>-${formatNumber(totalBuy)}</strong></td>
                    <td class="negative"><strong>-${formatNumber(totalFin)}</strong></td>
                    <td class="negative"><strong>-${formatNumber(totalOper)}</strong></td>
                </tr>
            `;

            // NPV row (calculated earlier)
            const npvBuy = capex + calculatePV(buyMonthly, discount, years);
            
            const residualValueCalc = capex * residualPct;
            const yearsAfterLease = years - yearsFin;
            let npvFin;
            if (yearsAfterLease > 0) {
                const pvLease = calculatePV(finMonthly, discount, yearsFin);
                const pvResidual = residualValueCalc / Math.pow(1 + discount/100, yearsFin);
                const pvPostLease = calculatePV(postLeaseMonthly, discount, yearsAfterLease) / Math.pow(1 + discount/100, yearsFin);
                npvFin = depositAmount + pvLease + pvResidual + pvPostLease;
            } else {
                npvFin = depositAmount + calculatePV(finMonthly, discount, yearsFin) + 
                        residualValueCalc / Math.pow(1 + discount/100, yearsFin);
            }
            
            const npvOper = depositOperAmount + calculatePV(operMonthly, discount, years);

            html += `
                <tr class="total-row" style="border-top: 2px solid #667eea;">
                    <td><strong>NPV (${discount}%)</strong></td>
                    <td class="negative"><strong>-${formatNumber(npvBuy)}</strong></td>
                    <td class="negative"><strong>-${formatNumber(npvFin)}</strong></td>
                    <td class="negative"><strong>-${formatNumber(npvOper)}</strong></td>
                </tr>
            `;

            document.getElementById('cashFlowBody').innerHTML = html;
            console.log('Cash flow table generated successfully');
            } catch (error) {
                console.error('Error generating cash flow table:', error);
            }
        }

        // Format number for cash flow table
        function formatNumber(value) {
            return new Intl.NumberFormat('vi-VN', {
                minimumFractionDigits: 1,
                maximumFractionDigits: 1
            }).format(value);
        }

        // Function to update management fee displays
        function updateManagementFeeDisplays() {
            const managementFee = parseFloat(document.getElementById('management-fee').value);
            document.getElementById('buy-mgmt').value = managementFee;
            document.getElementById('fin-mgmt').value = managementFee;
        }

        // Add event listeners to save input changes to localStorage (without calculating)
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', saveToLocalStorage);
        });

        // Add special event listener for management fee to update displays
        document.getElementById('management-fee').addEventListener('input', updateManagementFeeDisplays);
    </script>
</body>
</html>